From 0000000000000000000000000000000000000001 Mon Sep 17 00:00:00 2001
From: Your Name <you@example.com>
Date: Thu, 11 Dec 2025 00:00:01 +0000
Subject: [PATCH 1/3] probe: add optical dwell and warm-up for multi-sample probing

---
--- a/firmware/core/klippy/extras/probe.cpp
+++ b/firmware/core/klippy/extras/probe.cpp
@@ -5,6 +5,9 @@
 #define LOG_TAG "probe"
 #undef LOG_LEVEL
 #define LOG_LEVEL LOG_DEBUG
+// Added for small post-probe dwell and warm-up behavior
+#include <thread>
+#include <chrono>
 #include "log.h"
 #define PROBE_STATE_CALLBACK_SIZE 16
 static probe_state_callback_t probe_state_callback[PROBE_STATE_CALLBACK_SIZE];
@@ -253,6 +256,11 @@
     std::string samples_result = gcmd.get_string("SAMPLES_RESULT", m_samples_result);
     bool must_notify_multi_probe = !m_multi_probe_pending;
     // static double last_compensation_z_measure = 100000;
+        // Small dwell and optional warm-up for optical probes:
+        // - probe_dwell_ms: sleep after probe to allow sensor to settle
+        // - performed_warmup: per-run warm-up discard when using multiple samples
+        const int probe_dwell_ms = 5; // ms; adjust for your specific optical hardware
+        bool performed_warmup = false;
     if (must_notify_multi_probe)
     {
         multi_probe_begin();
@@ -286,6 +294,19 @@
         LOG_D("准备执行探测,当前Z 坐标%.6f,探测速度为%.2f\n", Printer::GetInstance()->m_tool_head->get_position()[2], speed); // 获取的这个位置是应用了position_endstop之后的坐标
         // 执行 run_G29_Z
         std::vector<double> pos = _probe(speed);                                                                              // 采集样本
+        // --- Added: short dwell to allow optical probe to stabilize ---
+        std::this_thread::sleep_for(std::chrono::milliseconds(probe_dwell_ms));
+
+        // --- Added: flush last move time (ensure moves completed/lookahead flushed) ---
+        Printer::GetInstance()->m_tool_head->get_last_move_time();
+
+        // Perform a single warm-up probe for multi-sample runs:
+        // helps optical probes stabilize thermally/optically at the start.
+        if (!performed_warmup && sample_count > 1) {
+            performed_warmup = true;
+            (void)_probe(speed); // discard warm-up result
+            std::this_thread::sleep_for(std::chrono::milliseconds(probe_dwell_ms));
+        }
         double z_pos = pos[2];
         std::vector<double> position = {pos[0], pos[1], z_pos};
 
